services:

    emi_db:
        image: mariadb:10.6
        container_name: emi_db
        security_opt:
            - seccomp:unconfined
        environment:
            - MYSQL_ROOT_PASSWORD=Emishops22!
            - MYSQL_DATABASE=emishops
        volumes:
            - ./infra/database/mysql:/docker-entrypoint-initdb.d/
            - "${DATABASE_FOLDER}:/var/lib/mysql"
        ports:
            - "${DATABASE_PORT}:3306"
        networks:
            - emi_network
        restart: always
        healthcheck:
            test: ["CMD", "mariadb", "-u", "root", "-pEmishops22!", "-e", "SELECT 1"]
            interval: 5s
            timeout: 5s
            retries: 20

    emi_db_init:
        image: mariadb:10.6
        container_name: emi_db_init
        security_opt:
            - seccomp:unconfined
        depends_on:
            emi_db:
                condition: service_healthy
        environment:
            - DB_HOST=emi_db
            - DB_USER=root
            - DB_PASSWORD=Emishops22!
            - DB_NAME=emishops
        volumes:
            - ./scripts:/scripts:ro
        entrypoint: ["/bin/bash", "/scripts/init-db.sh"]
        networks:
            - emi_network
        restart: "no"

    emi_phpmyadmin:
        image: phpmyadmin/phpmyadmin
        container_name: emi_phpmyadmin
        security_opt:
            - seccomp:unconfined
        depends_on:
            emi_db_init:
                condition: service_completed_successfully
        environment:
            - MYSQL_USERNAME=root
            - MYSQL_ROOT_PASSWORD=Emishops22!
            - PMA_HOST=emi_db
        restart: always
        ports:
            - "${PHPMYADMIN_PORT}:80"
        volumes:
            - /sessions
        networks:
            - emi_network

    emi_admin:
        container_name: emi_admin
        build: ./infra/admin
        security_opt:
            - seccomp:unconfined
        depends_on:
            emi_db_init:
                condition: service_completed_successfully
        volumes:
            - "${ADMIN_SRC_FOLDER}:/var/www/app"
        ports:
            -  "${ADMIN_PORT}:80"
        networks:
            - emi_network
        restart: always

networks:
    emi_network:
        driver: bridge
